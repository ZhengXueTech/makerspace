<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飛鳥遊戲 V2.0 - 點擊或空白鍵開始</title>
    
    <style>
        /* 1. 基礎與佈局 */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #333; /* 深色背景 */
            font-family: 'Arial Black', sans-serif;
            overflow: hidden;
        }

        #game-container {
            width: 400px;
            height: 600px;
            background-color: #70c5ce; /* 天空藍 */
            position: relative;
            border: 5px solid #000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden; 
            cursor: pointer; /* 提示可點擊 */
        }

        /* 2. 遊戲元素 */
        #bird {
            width: 30px;
            height: 30px;
            background-color: gold;
            border-radius: 50%; 
            border: 2px solid orange;
            position: absolute;
            left: 80px;
            top: 250px;
            z-index: 5;
            transition: transform 0.05s;
        }

        .pipe {
            width: 50px;
            background-color: #55a822; /* 管道綠 */
            border: 3px solid #000;
            position: absolute;
            right: -50px;
            box-sizing: border-box; /* 確保邊框不會增加寬度 */
        }

        .top-pipe { top: 0; }
        .bottom-pipe { bottom: 0; }

        /* 3. 介面元素 */
        #score {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 3em;
            color: white;
            text-shadow: 3px 3px #000;
            z-index: 10;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffcc00; /* 金色文字 */
            font-size: 1.5em;
            border-radius: 10px;
            border: 2px solid white;
            text-align: center;
            line-height: 1.4;
            z-index: 20;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    
    <div id="game-container">
        <div id="score">0</div>
        <div id="bird"></div>
        <div id="message">點擊或按空白鍵開始遊戲！</div>
    </div>
    
    <script>
        // --- 遊戲變數 ---
        const gameContainer = document.getElementById('game-container');
        const bird = document.getElementById('bird');
        const scoreDisplay = document.getElementById('score');
        const message = document.getElementById('message');

        let gameRunning = false;
        let birdY = 250; 
        const BIRD_X = 80;
        let velocity = 0; 
        const GRAVITY = 0.5;
        const JUMP_STRENGTH = -10;
        let score = 0;

        const PIPE_WIDTH = 50;
        const GAME_HEIGHT = 600;
        const PIPE_GAP = 150; 
        const PIPE_SPAWN_RATE = 1500; // 毫秒

        let gameLoop = null;
        let pipeGenerator = null;

        // --- 核心函數 ---

        function handleJump(e) {
            // 阻止鍵盤空白鍵滾動頁面
            if (e.type === 'keydown' && e.code === 'Space') {
                e.preventDefault();
            }

            if (!gameRunning) {
                // 如果遊戲未運行，則開始遊戲
                startGame();
            } else {
                // 如果遊戲正在運行，則執行跳躍
                velocity = JUMP_STRENGTH;
                bird.style.transform = `rotate(-30deg)`; // 向上傾斜
            }
        }

        function startGame() {
            if (gameRunning) return; // 避免重複啟動

            console.log("遊戲啟動...");
            gameRunning = true;
            score = 0;
            birdY = 250;
            velocity = 0;
            scoreDisplay.textContent = `0`;
            message.classList.add('hidden');

            // 移除舊的管道
            document.querySelectorAll('.pipe').forEach(pipe => pipe.remove());

            // 設置鳥的初始位置
            bird.style.top = `${birdY}px`;
            
            // 啟動遊戲計時器
            gameLoop = setInterval(updateGame, 20); 
            pipeGenerator = setInterval(createPipe, PIPE_SPAWN_RATE);

            // 確保事件監聽器只註冊一次
            document.addEventListener('keydown', handleJump);
            gameContainer.addEventListener('click', handleJump);
        }

        function stopGame() {
            if (!gameRunning) return; // 避免重複停止

            console.log("遊戲結束！");
            gameRunning = false;
            clearInterval(gameLoop);
            clearInterval(pipeGenerator);

            message.innerHTML = `遊戲結束！<br>最終得分: <b>${score}</b>。<br>點擊或按空白鍵重新開始。`;
            message.classList.remove('hidden');
            
            // 移除事件監聽器以防止錯誤
            document.removeEventListener('keydown', handleJump);
            gameContainer.removeEventListener('click', handleJump);
        }

        function updateGame() {
            // 1. 重力與移動
            velocity += GRAVITY;
            birdY += velocity;
            
            // 更新鳥的位置和旋轉 (模擬下降)
            bird.style.top = `${birdY}px`;
            if (velocity > 0) {
                bird.style.transform = `rotate(45deg)`; // 向下傾斜
            }

            // 2. 邊界碰撞 (地面與天空)
            const BIRD_HEIGHT = 30; 
            if (birdY < 0 || birdY + BIRD_HEIGHT > GAME_HEIGHT) { 
                stopGame();
                return;
            }

            // 3. 管道更新與碰撞檢測
            document.querySelectorAll('.pipe').forEach(pipe => {
                let pipeX = pipe.offsetLeft;
                pipe.style.left = `${pipeX - 2}px`; // 管道向左移動 2px

                // 檢查得分
                if (pipeX + PIPE_WIDTH < BIRD_X && !pipe.dataset.passed) {
                    pipe.dataset.passed = true; // 標記為已通過
                    score++;
                    scoreDisplay.textContent = `${score}`;
                }

                // 碰撞檢測 (只檢查鳥通過的那個管道)
                if (pipeX < BIRD_X + BIRD_HEIGHT && pipeX + PIPE_WIDTH > BIRD_X) { 
                    
                    const isTopPipe = pipe.classList.contains('top-pipe');
                    const pipeEdge = isTopPipe ? pipe.offsetHeight : GAME_HEIGHT - pipe.offsetHeight;

                    if (isTopPipe && birdY < pipeEdge) {
                        stopGame(); // 撞到上管
                    } else if (!isTopPipe && birdY + BIRD_HEIGHT > pipeEdge) {
                        stopGame(); // 撞到下管
                    }
                }

                // 移除移出畫面的管道 (節省資源)
                if (pipeX + PIPE_WIDTH < 0) {
                    pipe.remove();
                }
            });
        }

        function createPipe() {
            const minHeight = 50;
            const maxHeight = GAME_HEIGHT - PIPE_GAP - minHeight;
            // 隨機決定上管的高度
            const topHeight = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
            const bottomHeight = GAME_HEIGHT - topHeight - PIPE_GAP;

            // 創建上管
            const topPipe = document.createElement('div');
            topPipe.classList.add('pipe', 'top-pipe');
            topPipe.style.height = `${topHeight}px`;

            // 創建下管
            const bottomPipe = document.createElement('div');
            bottomPipe.classList.add('pipe', 'bottom-pipe');
            bottomPipe.style.height = `${bottomHeight}px`;

            // 加入到遊戲容器
            gameContainer.appendChild(topPipe);
            gameContainer.appendChild(bottomPipe);
        }

        // --- 啟動事件監聽器 (首次加載) ---
        // 為了避免重複添加，初始時只監聽一次
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                handleJump(e);
            }
        });
        gameContainer.addEventListener('click', handleJump);
        
        console.log("檔案加載完成。請點擊畫面或按空白鍵開始遊戲。");
    </script>
</body>
</html>

