<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²ªåƒè›‡éŠæˆ² (é«˜ç§‘æŠ€ç‰ˆæœ¬ - é“å…·æ¨¡å¼ - å¯éƒ¨ç½²HTML)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans TC å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!--
        ** é‡è¦æé†’ **
        é€™å€‹å€å¡Šæ˜¯ç‚ºäº†åœ¨ Immersive ç’°å¢ƒä¸­é‹è¡Œè€Œè¨­è¨ˆçš„ã€‚
        å¦‚æœæ‚¨å°‡é€™å€‹æª”æ¡ˆéƒ¨ç½²åˆ°æ‚¨è‡ªå·±çš„ä¼ºæœå™¨ï¼Œæ‚¨éœ€è¦å°‡é€™æ®µè…³æœ¬ä¿®æ”¹ç‚ºæ‚¨çš„ Firebase é…ç½®ï¼Œ
        æˆ–è€…ç›´æ¥ç§»é™¤ï¼Œè®“éŠæˆ²åœ¨æ²’æœ‰é›²ç«¯åˆ†æ•¸åŒæ­¥åŠŸèƒ½çš„æƒ…æ³ä¸‹é‹è¡Œã€‚
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– (åœ¨ Canvas ç’°å¢ƒä¸­ç”±ç³»çµ±æä¾›)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            // åˆå§‹åŒ– Firebase App
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.appId = appId;
            setLogLevel('Debug');

            // è™•ç†èº«ä»½é©—è­‰
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                        window.userId = window.auth.currentUser.uid;
                        window.isAuthReady = true;
                        if (typeof window.initGameLogic === 'function') {
                            window.initGameLogic();
                        }
                    } catch (error) {
                        console.error("Firebase èªè­‰å¤±æ•—:", error);
                        window.isAuthReady = true;
                        if (typeof window.initGameLogic === 'function') {
                            window.initGameLogic();
                        }
                    }
                } else {
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    if (typeof window.initGameLogic === 'function') {
                        window.initGameLogic();
                    }
                }
            });

            // é™„åŠ  Firestore å‡½å¼
            window.firestore = {
                getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, getDocs
            };
        } else {
            console.warn("Firebase é…ç½®éºå¤±ã€‚éŠæˆ²å°‡åœ¨æ²’æœ‰åˆ†æ•¸å„²å­˜åŠŸèƒ½çš„æƒ…æ³ä¸‹é‹è¡Œã€‚");
            window.isAuthReady = true;
            if (typeof window.initGameLogic === 'function') {
                window.initGameLogic();
            }
        }
    </script>
    <style>
        /* ä½¿ç”¨ Noto Sans TC ä½œç‚ºä¸»è¦å­—é«” */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #000000; /* æ·±é»‘èƒŒæ™¯ */
        }
       
        /* ç§‘æŠ€æ„Ÿæ–‡å­—é¡è‰²èˆ‡å…‰æšˆ */
        .text-neon-cyan {
            color: #00FFFF;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
        }
        .text-neon-magenta {
            color: #FF00FF;
            text-shadow: 0 0 8px rgba(255, 0, 255, 0.8);
        }

        /* éŠæˆ²ç•«å¸ƒçš„åŸºæœ¬æ¨£å¼ */
        #gameCanvas {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7), 0 0 5px rgba(0, 255, 255, 0.3); /* éœ“è™¹é’è‰²å…‰æšˆ */
            border-radius: 4px;
            background-color: #05050A; /* æ¥è¿‘é»‘è‰²çš„æ·±è—è‰² */
            touch-action: none; /* ç¦ç”¨ç€è¦½å™¨é è¨­çš„è§¸æ§æ“ä½œ */
            border: 1px solid #00FFFF; /* é‚Šæ¡† */
        }
        /* æŒ‰éˆ•æ¨£å¼ */
        .game-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #00B3B3; /* éœ“è™¹è‰²é™°å½± */
            text-shadow: 0 0 5px #00FFFF;
        }
        .game-button:hover {
            transform: translateY(1px);
            box-shadow: 0 3px #00B3B3;
        }
        .game-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 #00B3B3;
        }

        /* éŠæˆ²çµæŸç–ŠåŠ å±¤ */
        #gameOverOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 4px;
        }

        /* è§¸æ§æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .touch-control {
            background-color: #1a1a2e;
            color: #00FFFF;
            padding: 1rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .touch-control:active {
            background-color: #2a2a44;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }
       
        /* ä½¿ç”¨è€… ID çš„é€£çµ/ç§‘æŠ€æ–‡å­—æ¨£å¼ */
        .user-id-link {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: #FF00FF;
            transition: color 0.1s, text-shadow 0.1s;
        }
        .user-id-link:hover {
            color: #FFFFFF;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">

    <h1 class="text-4xl font-bold text-neon-cyan mb-6 tracking-wider">ğŸ’» ç§‘æŠ€è¿´è·¯è²ªåƒè›‡ ğŸŒ</h1>

    <!-- éŠæˆ²ä¸»å®¹å™¨ -->
    <div class="flex flex-col lg:flex-row w-full max-w-6xl gap-6">

        <!-- å·¦å´ï¼šéŠæˆ²å€åŸŸå’Œæ§åˆ¶é … -->
        <div class="lg:w-3/5 w-full bg-gray-900 p-4 sm:p-6 rounded-xl shadow-2xl relative border border-cyan-700/50">
            <h2 class="text-2xl font-semibold text-white mb-4 text-center text-neon-cyan">ç³»çµ±é‹è¡Œä¸­...</h2>

            <!-- è¨˜åˆ†æ¿å’Œç‹€æ…‹ -->
            <div class="flex justify-between items-center text-lg font-mono mb-4 text-neon-cyan">
                <span>åˆ†æ•¸: <span id="score" class="text-neon-magenta">0</span></span>
                <!-- èª¿æ•´äº†ä½¿ç”¨è€… ID çš„é¡¯ç¤ºæ¨£å¼ -->
                <span class="text-xl font-bold">ä½¿ç”¨è€… ID:
                    <span id="userIdDisplay" class="text-yellow-400 text-sm break-all user-id-link"></span>
                </span>
            </div>
           
            <!-- é“å…·ç‹€æ…‹ -->
            <div id="powerUpStatus" class="hidden mt-2 p-2 rounded-lg bg-yellow-900/50 border border-yellow-500/80 text-center text-sm">
                <span class="text-yellow-300 font-bold">é“å…·å•Ÿå‹•:</span>
                <span id="activePowerUpDisplay" class="text-yellow-100 mr-2"></span>
                <span class="text-yellow-400 font-mono">å€’æ•¸: <span id="powerUpTimerDisplay"></span></span>
            </div>


            <!-- éŠæˆ²ç•«å¸ƒå’Œç–ŠåŠ å±¤ -->
            <div id="canvasContainer" class="relative w-full aspect-square max-w-[500px] mx-auto mt-4">
                <canvas id="gameCanvas" class="w-full h-full"></canvas>
                <!-- éŠæˆ²çµæŸç–ŠåŠ å±¤ -->
                <div id="gameOverOverlay" class="absolute top-0 left-0 flex flex-col justify-center items-center text-white p-4">
                    <h3 class="text-5xl font-extrabold text-neon-magenta mb-4 animate-pulse">ç³»çµ±æ•…éšœ (Game Over)ï¼</h3>
                    <p class="text-2xl mb-2 text-neon-cyan">æœ¬æ¬¡è³‡æ–™åŒ…å¤§å°: <span id="finalScore" class="font-bold text-neon-magenta">0</span></p>
                    <p class="text-xl text-gray-300">æŒ‰ä¸‹ <span class="font-bold text-neon-cyan">Enter</span> é€²è¡Œé‡å•Ÿ</p>
                    <p class="text-sm mt-4 text-gray-400">(æˆ–é»æ“Šã€Œé–‹å§‹ã€æŒ‰éˆ•)</p>
                </div>
            </div>

            <!-- è§¸æ§æ§åˆ¶æŒ‰éˆ• (åƒ…åœ¨å°è¢å¹•ä¸Šé¡¯ç¤º) -->
            <div id="touchControls" class="mt-6 flex flex-col items-center space-y-2 sm:hidden">
                <div class="flex space-x-2">
                    <button class="touch-control w-16 h-16" data-direction="UP">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </div>
                <div class="flex space-x-8">
                    <button class="touch-control w-16 h-16" data-direction="LEFT">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <button class="touch-control w-16 h-16" data-direction="RIGHT">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button class="touch-control w-16 h-16" data-direction="DOWN">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </button>
                </div>
            </div>


            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div class="mt-6 flex justify-center space-x-4">
                <button id="startButton" class="game-button bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl text-lg">
                    [å•Ÿå‹•] é–‹å§‹éŠæˆ²
                </button>
                <button id="pauseButton" class="game-button bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-6 rounded-xl text-lg" disabled>
                    [æš«åœ] å‡çµç³»çµ±
                </button>
            </div>
        </div>

        <!-- å³å´ï¼šæœ€é«˜åˆ†æ•¸æ¦œ -->
        <div class="lg:w-2/5 w-full bg-gray-900 p-4 sm:p-6 rounded-xl shadow-2xl border border-cyan-700/50">
            <h2 class="text-2xl font-semibold text-neon-magenta mb-4 text-center">ğŸ“Š è³‡æ–™åŒ…æ’è¡Œæ¦œ</h2>
            <div id="highScoresList" class="space-y-3 text-white">
                <p id="loadingScores" class="text-center text-gray-400">æ­£åœ¨è¼‰å…¥æ•¸æ“šæµ...</p>
                <!-- åˆ†æ•¸åˆ—è¡¨å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
            <p class="text-sm mt-6 text-center text-gray-500">
                æ‚¨çš„è³‡æ–™åŒ…åˆ†æ•¸å°‡åœ¨å…¨çƒç¶²çµ¡ä¸­å³æ™‚åŒæ­¥ã€‚
            </p>
        </div>

    </div>

    <!-- éŠæˆ²é‚è¼¯è…³æœ¬ -->
    <script>
        // =================================================================
        // 1. éŠæˆ²è¨­å®šå’Œåˆå§‹åŒ–
        // =================================================================

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('finalScore');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const highScoresList = document.getElementById('highScoresList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const powerUpStatus = document.getElementById('powerUpStatus');
        const activePowerUpDisplay = document.getElementById('activePowerUpDisplay');
        const powerUpTimerDisplay = document.getElementById('powerUpTimerDisplay');


        // éŠæˆ²åƒæ•¸
        const GRID_SIZE = 20; // ç¶²æ ¼å¤§å° (æ ¼å­æ•¸)
        let TILE_SIZE;       // æ¯å€‹æ ¼å­åœ¨ç•«å¸ƒä¸Šçš„åƒç´ å¤§å°
        let speed = 150;     // éŠæˆ²é€Ÿåº¦ (æ¯«ç§’)
        const DEFAULT_SPEED = 150; // é è¨­é€Ÿåº¦
        const TURBO_SPEED = 75;    // æ¥µé€Ÿæ™¶ç‰‡çš„é€Ÿåº¦
        const POWER_UP_DURATION = 7000; // é“å…·æŒçºŒæ™‚é–“ (æ¯«ç§’)
        const POWER_UP_CHANCE = 0.2; // é“å…·å‡ºç¾æ©Ÿç‡ (20%)

        let gameLoop;        // å„²å­˜ setInterval å¯¦ä¾‹
        let isPaused = true; // éŠæˆ²æ˜¯å¦æš«åœ
        let isGameOver = false;

        // éŠæˆ²ç‹€æ…‹
        let snake;
        let food;
        let powerUp = null; // æ–°å¢ï¼šç›®å‰çš„é“å…·ä½ç½®å’Œé¡å‹
        let activePowerUp = null; // æ–°å¢ï¼šå•Ÿå‹•ä¸­çš„é“å…·é¡å‹
        let powerUpTimer = 0; // æ–°å¢ï¼šé“å…·å‰©é¤˜æ™‚é–“
        let dx = 0; // x è»¸æ–¹å‘
        let dy = 0; // y è»¸æ–¹å‘
        let score = 0;
        let changingDirection = false; // ç”¨æ–¼é˜²æ­¢è›‡åœ¨ä¸€å€‹éŠæˆ²é€±æœŸå…§èª¿é ­

        // é“å…·é¡å‹å®šç¾©
        const POWER_UP_TYPES = {
            TURBO_SPEED: 'TURBO_SPEED', // æ¥µé€Ÿæ™¶ç‰‡
            SCORE_MULTIPLIER: 'SCORE_MULTIPLIER' // åˆ†æ•¸å¢å¹…
        };

        // æœ€é«˜åˆ†æ•¸ç›¸é—œè®Šæ•¸
        const MAX_HIGH_SCORES = 5;
        let currentHighScores = [];

        /**
         * åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹å’Œè®Šæ•¸ã€‚
         */
        function initializeGame() {
            // è¨ˆç®— TILE_SIZE ä»¥é©æ‡‰ç•«å¸ƒå®¹å™¨å¤§å°
            resizeCanvas();

            // è¨­å®šè›‡çš„åˆå§‹ä½ç½® (é è¿‘ä¸­å¿ƒ)
            snake = [{ x: Math.floor(GRID_SIZE / 2) * TILE_SIZE, y: Math.floor(GRID_SIZE / 2) * TILE_SIZE }];
           
            // é‡ç½®ç‹€æ…‹å’Œåƒæ•¸
            dx = TILE_SIZE;
            dy = 0;
            score = 0;
            speed = DEFAULT_SPEED;
            powerUp = null;
            activePowerUp = null;
            powerUpTimer = 0;

            scoreDisplay.textContent = score;
            isPaused = true;
            isGameOver = false;
            changingDirection = false;
            powerUpStatus.classList.add('hidden'); // éš±è—é“å…·ç‹€æ…‹

            // æ¸…é™¤ç•«å¸ƒå’ŒéŠæˆ²çµæŸç–ŠåŠ å±¤
            drawCanvas();
            drawSnake();
            gameOverOverlay.style.display = 'none';
           
            // éš¨æ©Ÿæ”¾ç½®ç¬¬ä¸€å€‹é£Ÿç‰©æˆ–é“å…·
            createFoodOrPowerUp();

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            startButton.textContent = '[å•Ÿå‹•] é–‹å§‹éŠæˆ²';
            startButton.disabled = false;
            pauseButton.disabled = true;

            // é¡¯ç¤ºä½¿ç”¨è€… ID (å¦‚æœ Firebase æœªé€£ç·šï¼Œå°‡é¡¯ç¤º 'æœªé€£ç·š')
            userIdDisplay.textContent = window.userId || 'æœªé€£ç·š';
        }

        /**
         * èª¿æ•´ç•«å¸ƒå¤§å°ä»¥åŒ¹é…å®¹å™¨ï¼Œä¸¦é‡æ–°è¨ˆç®— TILE_SIZEã€‚
         */
        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            // ç¢ºä¿ç•«å¸ƒæ˜¯æ­£æ–¹å½¢ï¼Œä¸¦æ ¹æ“š GRID_SIZE è¨­å®šå¤§å°
            const size = Math.min(container.clientWidth, container.clientHeight);
            canvas.width = size;
            canvas.height = size;
            TILE_SIZE = canvas.width / GRID_SIZE;
           
            // å¦‚æœéŠæˆ²æ­£åœ¨é‹è¡Œï¼Œéœ€è¦é‡æ–°ç¹ªè£½æ‰€æœ‰å…§å®¹
            if (dx !== 0 || dy !== 0 || isGameOver) {
                drawCanvas();
                if (food) drawFood();
                if (powerUp) drawPowerUp();
                drawSnake();
                if (isGameOver) {
                    // é‡æ–°å®šä½ç–ŠåŠ å±¤
                    gameOverOverlay.style.width = `${size}px`;
                    gameOverOverlay.style.height = `${size}px`;
                    gameOverOverlay.style.display = 'flex';
                }
            }
        }

        // ç¢ºä¿ç•«å¸ƒåœ¨è¦–çª—å¤§å°è®Šæ›´æ™‚ä¿æŒéŸ¿æ‡‰
        window.addEventListener('resize', resizeCanvas);


        // =================================================================
        // 2. éŠæˆ²ç¹ªåœ–åŠŸèƒ½ (é«˜ç§‘æŠ€/éœ“è™¹ä¸»é¡Œ)
        // =================================================================

        /**
         * ç¹ªè£½éŠæˆ²ç¶²æ ¼å’ŒèƒŒæ™¯ã€‚
         */
        function drawCanvas() {
            // èƒŒæ™¯ (æ·±é»‘)
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½ç§‘æŠ€æ„Ÿç¶²æ ¼
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.1)'; // é€æ˜çš„é’è‰²
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                // å‚ç›´ç·š
                ctx.beginPath();
                ctx.moveTo(i * TILE_SIZE, 0);
                ctx.lineTo(i * TILE_SIZE, canvas.height);
                ctx.stroke();
                // æ°´å¹³ç·š
                ctx.beginPath();
                ctx.moveTo(0, i * TILE_SIZE);
                ctx.lineTo(canvas.width, i * TILE_SIZE);
                ctx.stroke();
            }
        }

        /**
         * ç¹ªè£½è›‡çš„èº«é«” (éœ“è™¹ç¶ )ã€‚
         */
        function drawSnake() {
            snake.forEach((segment, index) => {
                // è¨­ç½®éœ“è™¹ç¶ è‰²å’Œå…‰æšˆæ•ˆæœ
                ctx.shadowColor = '#00FF00';
                ctx.shadowBlur = index === 0 ? 15 : 8; // è›‡é ­å…‰æšˆæ›´äº®

                // è›‡é ­ä½¿ç”¨ä¸åŒé¡è‰²
                if (index === 0) {
                    ctx.fillStyle = '#00FF00'; // éœ“è™¹ç¶ 
                } else {
                    ctx.fillStyle = '#00CC00'; // ç¨å¾®æš—ä¸€é»çš„éœ“è™¹ç¶ 
                }
               
                ctx.fillRect(segment.x, segment.y, TILE_SIZE, TILE_SIZE);
               
                // å¢åŠ é‚Šæ¡†å¢åŠ è³ªæ„Ÿ (ä½¿ç”¨é»‘è‰²ä»¥å¼·èª¿éœ“è™¹å…‰)
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.strokeRect(segment.x, segment.y, TILE_SIZE, TILE_SIZE);
            });

            // é‡ç½®å…‰æšˆ
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }

        /**
         * ç¹ªè£½é£Ÿç‰© (éœ“è™¹æ´‹ç´…/è³‡æ–™åŒ…)ã€‚
         */
        function drawFood() {
            if (!food) return;
            // è¨­ç½®éœ“è™¹æ´‹ç´…è‰²å’Œå¼·çƒˆå…‰æšˆæ•ˆæœ
            ctx.shadowColor = '#FF00FF';
            ctx.shadowBlur = 15;
            ctx.fillStyle = '#FF00FF'; // éœ“è™¹æ´‹ç´…
           
            // ç¹ªè£½åœ“å½¢ (é£Ÿç‰©)
            ctx.beginPath();
            ctx.arc(food.x + TILE_SIZE / 2, food.y + TILE_SIZE / 2, TILE_SIZE / 2 * 0.7, 0, 2 * Math.PI);
            ctx.fill();
           
            // é‡ç½®å…‰æšˆ
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }

        /**
         * ç¹ªè£½é“å…· (ä½¿ç”¨ Emoji ç¬¦è™Ÿ)ã€‚
         */
        function drawPowerUp() {
            if (!powerUp) return;

            let color, symbol;
            switch (powerUp.type) {
                case POWER_UP_TYPES.TURBO_SPEED:
                    color = '#FFFF00'; // Yellow
                    symbol = 'âš¡';
                    break;
                case POWER_UP_TYPES.SCORE_MULTIPLIER:
                    color = '#FF4500'; // Orange-Red
                    symbol = 'ğŸ’°';
                    break;
                default:
                    return;
            }

            // è¨­ç½®å…‰æšˆ
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;

            // ç•«ä¸€å€‹å¤–æ¡†æˆ–èƒŒæ™¯
            ctx.fillStyle = '#100020'; // æ·±ç´«è‰²èƒŒæ™¯
            ctx.fillRect(powerUp.x, powerUp.y, TILE_SIZE, TILE_SIZE);
           
            // ç•« emoji ç¬¦è™Ÿ
            ctx.font = `${TILE_SIZE * 0.8}px 'Noto Sans TC'`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, powerUp.x + TILE_SIZE / 2, powerUp.y + TILE_SIZE / 2);

            // é‡ç½®å…‰æšˆ
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }


        // =================================================================
        // 3. éŠæˆ²é‚è¼¯ (åŒ…å«é“å…·)
        // =================================================================

        /**
         * æª¢æŸ¥çµ¦å®šçš„åº§æ¨™æ˜¯å¦èˆ‡è›‡é‡ç–Šã€‚
         * @param {object} pos - æ¸¬è©¦åº§æ¨™ {x, y}
         * @returns {boolean} - æ˜¯å¦åœ¨è›‡ä¸Š
         */
        function isPosOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        /**
         * éš¨æ©Ÿç”Ÿæˆé£Ÿç‰©æˆ–é“å…·ã€‚
         */
        function createFoodOrPowerUp() {
            const chance = Math.random();

            if (chance < POWER_UP_CHANCE && powerUp === null) {
                // 20% æ©Ÿç‡ç”Ÿæˆé“å…·
                createPowerUp();
            } else {
                // 80% æ©Ÿç‡ç”Ÿæˆé£Ÿç‰©
                createFood();
            }
        }

        /**
         * åœ¨ç•«å¸ƒä¸Šéš¨æ©Ÿç”Ÿæˆé£Ÿç‰©ã€‚
         */
        function createFood() {
            let newFood;
            do {
                const foodX = Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE;
                const foodY = Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE;
                newFood = { x: foodX, y: foodY };
            } while (isPosOnSnake(newFood));

            food = newFood;
            powerUp = null; // æ¸…é™¤é“å…·
        }

        /**
         * åœ¨ç•«å¸ƒä¸Šéš¨æ©Ÿç”Ÿæˆé“å…·ã€‚
         */
        function createPowerUp() {
            let newPowerUp;
            // éš¨æ©Ÿé¸æ“‡é“å…·é¡å‹
            let type = Math.random() < 0.5 ? POWER_UP_TYPES.TURBO_SPEED : POWER_UP_TYPES.SCORE_MULTIPLIER;
            do {
                const puX = Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE;
                const puY = Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE;
                newPowerUp = { x: puX, y: puY, type: type };
            } while (isPosOnSnake(newPowerUp));
           
            food = null; // æ¸…é™¤é£Ÿç‰©
            powerUp = newPowerUp;
        }


        /**
         * è™•ç†é“å…·æ•ˆæœå•Ÿå‹•ã€‚
         * @param {string} type - é“å…·é¡å‹
         */
        function applyPowerUp(type) {
            // é‡è¨­è¨ˆæ™‚å™¨ä¸¦å•Ÿå‹•é“å…·
            activePowerUp = type;
            powerUpTimer = POWER_UP_DURATION;
           
            // æ›´æ–° UI
            powerUpStatus.classList.remove('hidden');
            activePowerUpDisplay.textContent = getPowerUpName(type);

            if (type === POWER_UP_TYPES.TURBO_SPEED) {
                // æ¥µé€Ÿæ™¶ç‰‡ï¼šæ”¹è®Šé€Ÿåº¦
                speed = TURBO_SPEED;
                clearInterval(gameLoop);
                gameLoop = setInterval(update, speed);
            }
            // åˆ†æ•¸å¢å¹…å™¨ï¼šæ•ˆæœåœ¨åƒåˆ°ä¸‹ä¸€é¡†é£Ÿç‰©æ™‚è™•ç†
        }

        /**
         * è™•ç†é“å…·è¨ˆæ™‚å™¨å’Œæ•ˆæœéæœŸã€‚
         */
        function handlePowerUpTimer() {
            if (activePowerUp === POWER_UP_TYPES.TURBO_SPEED) {
                // åªæœ‰é€Ÿåº¦é“å…·éœ€è¦å€’æ•¸è¨ˆæ™‚å™¨
                powerUpTimer -= speed; // é“å…·æ™‚é–“éš¨éŠæˆ²é€Ÿåº¦æµé€
               
                // æ›´æ–° UI å€’æ•¸è¨ˆæ™‚
                const remaining = Math.max(0, Math.ceil(powerUpTimer / 1000));
                powerUpTimerDisplay.textContent = `${remaining}s`;

                if (powerUpTimer <= 0) {
                    // æ¥µé€Ÿæ™¶ç‰‡éæœŸ
                    activePowerUp = null;
                    speed = DEFAULT_SPEED; // æ¢å¾©é è¨­é€Ÿåº¦
                    clearInterval(gameLoop);
                    gameLoop = setInterval(update, speed);
                   
                    // é‡è¨­ UI
                    powerUpStatus.classList.add('hidden');
                    activePowerUpDisplay.textContent = '';
                    powerUpTimerDisplay.textContent = '';
                }
            } else if (activePowerUp === POWER_UP_TYPES.SCORE_MULTIPLIER) {
                 // åˆ†æ•¸å¢å¹…å™¨ï¼šä¸éœ€è¦è¨ˆæ™‚å™¨ï¼Œåªéœ€é¡¯ç¤ºç‹€æ…‹
                powerUpTimerDisplay.textContent = 'NEXT';
            }
        }
       
        /**
         * æ ¹æ“šé¡å‹è¿”å›é“å…·çš„é¡¯ç¤ºåç¨±ã€‚
         */
        function getPowerUpName(type) {
            switch(type) {
                case POWER_UP_TYPES.TURBO_SPEED: return "æ¥µé€Ÿæ™¶ç‰‡ âš¡";
                case POWER_UP_TYPES.SCORE_MULTIPLIER: return "åˆ†æ•¸å¢å¹… ğŸ’°";
                default: return "";
            }
        }


        /**
         * è™•ç†éŠæˆ²çµæŸé‚è¼¯ï¼ŒåŒ…æ‹¬åˆ†æ•¸å„²å­˜ã€‚
         */
        async function handleGameOver() {
            isGameOver = true;
            isPaused = true;
            clearInterval(gameLoop);
           
            // é‡ç½®é€Ÿåº¦ï¼Œä»¥é˜²æ˜¯åŠ é€Ÿç‹€æ…‹çµæŸéŠæˆ²
            speed = DEFAULT_SPEED;
            activePowerUp = null;
            powerUpStatus.classList.add('hidden');

            // é¡¯ç¤ºéŠæˆ²çµæŸç–ŠåŠ å±¤
            finalScoreDisplay.textContent = score;
            gameOverOverlay.style.display = 'flex';
           
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            pauseButton.disabled = true;
            startButton.textContent = 'é‡æ–°å•Ÿå‹• (Enter)';
            startButton.disabled = false;

            // å„²å­˜æœ€é«˜åˆ†æ•¸ (å¦‚æœ Firebase å•Ÿå‹•)
            if (window.isAuthReady && window.db) {
                await saveHighScore(score);
            }
        }

        /**
         * æª¢æŸ¥è›‡æ˜¯å¦æ’åˆ°ç‰†å£æˆ–è‡ªå·±çš„èº«é«”ã€‚
         * @returns {boolean} - æ˜¯å¦ç™¼ç”Ÿç¢°æ’
         */
        function checkCollision() {
            const head = snake[0];
            const maxPos = canvas.width - TILE_SIZE;

            // æ’åˆ°ç‰†å£
            const hitWall = head.x < 0 || head.x > maxPos || head.y < 0 || head.y > maxPos;

            // æ’åˆ°è‡ªå·±çš„èº«é«” (å¾ç¬¬å››å€‹ç‰‡æ®µé–‹å§‹æª¢æŸ¥)
            const hitSelf = snake.slice(4).some(segment => segment.x === head.x && segment.y === head.y);

            return hitWall || hitSelf;
        }

        /**
         * ä¸»éŠæˆ²æ›´æ–°å‡½æ•¸ï¼Œåœ¨æ¯å€‹æ™‚é–“é–“éš”é‹è¡Œã€‚
         */
        function update() {
            if (isPaused || isGameOver) return;

            changingDirection = false;

            // æª¢æŸ¥ç¢°æ’
            if (checkCollision()) {
                handleGameOver();
                return;
            }

            // ç§»å‹•è›‡ï¼šå‰µå»ºæ–°çš„é ­éƒ¨ä¸¦å°‡å…¶æ·»åŠ åˆ°è›‡çš„é–‹é ­
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head);
           
            let itemConsumed = false;

            // 1. æª¢æŸ¥æ˜¯å¦åƒåˆ°é“å…·
            if (powerUp && head.x === powerUp.x && head.y === powerUp.y) {
                applyPowerUp(powerUp.type);
                powerUp = null;
                itemConsumed = true;
                score += 5; // åƒé“å…·çµ¦å°‘é‡åˆ†æ•¸
            }
            // 2. æª¢æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            else if (food && head.x === food.x && head.y === food.y) {
                let scoreIncrease = 10;
                // æª¢æŸ¥åˆ†æ•¸å¢å¹…å™¨æ˜¯å¦å•Ÿå‹•ä¸­
                if (activePowerUp === POWER_UP_TYPES.SCORE_MULTIPLIER) {
                    scoreIncrease *= 3; // ä¸‰å€åˆ†æ•¸
                    activePowerUp = null; // å¢å¹…å™¨åªä½œç”¨ä¸€æ¬¡
                    powerUpStatus.classList.add('hidden'); // éš±è—å¢å¹…å™¨ç‹€æ…‹
                }
                score += scoreIncrease;
                scoreDisplay.textContent = score;
                food = null;
                itemConsumed = true;
            }

            if (itemConsumed) {
                // åƒåˆ°é£Ÿç‰©æˆ–é“å…·ï¼Œè›‡ç”Ÿé•·ï¼Œä¸¦ç”Ÿæˆä¸‹ä¸€å€‹ç‰©å“
                createFoodOrPowerUp();
            } else {
                // æ­£å¸¸ç§»å‹•ï¼Œç§»é™¤å°¾éƒ¨
                snake.pop();
            }

            // è™•ç†é“å…·è¨ˆæ™‚å™¨å’Œæ•ˆæœéæœŸ
            handlePowerUpTimer();


            // é‡æ–°ç¹ªè£½
            drawCanvas();
            if (food) drawFood();
            if (powerUp) drawPowerUp();
            drawSnake();
        }

        /**
         * é–‹å§‹æˆ–ç¹¼çºŒéŠæˆ²ã€‚
         */
        function startGame() {
            if (isGameOver) {
                initializeGame();
                // é‡æ–°åˆå§‹åŒ–å¾Œï¼Œè®“å®ƒé€²å…¥æ­£å¸¸å•Ÿå‹•æµç¨‹
            }
           
            if (isPaused) {
                isPaused = false;
                gameLoop = setInterval(update, speed);
                startButton.textContent = 'è³‡æ–™æµå‚³è¼¸ä¸­...';
                startButton.disabled = true;
                pauseButton.disabled = false;
            }
        }

        /**
         * æš«åœéŠæˆ²ã€‚
         */
        function pauseGame() {
            if (!isPaused && !isGameOver) {
                isPaused = true;
                clearInterval(gameLoop);
                startButton.textContent = '[ç¹¼çºŒ] æ¢å¾©é‹è¡Œ';
                startButton.disabled = false;
                pauseButton.disabled = true;
            }
        }

        // =================================================================
        // 4. äº‹ä»¶è™•ç†å’Œæ§åˆ¶é …
        // =================================================================

        // éµç›¤æ§åˆ¶é …
        document.addEventListener('keydown', (event) => {
            // é¿å…åœ¨ä¸€å€‹éŠæˆ²é€±æœŸå…§å¤šæ¬¡æ”¹è®Šæ–¹å‘ï¼Œæˆ–è©¦åœ–èª¿é ­
            if (changingDirection) return;
            changingDirection = true;

            const keyPressed = event.key;
            const goingUp = dy === -TILE_SIZE;
            const goingDown = dy === TILE_SIZE;
            const goingRight = dx === TILE_SIZE;
            const goingLeft = dx === -TILE_SIZE;

            switch (keyPressed) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (!goingRight) { dx = -TILE_SIZE; dy = 0; }
                    break;
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (!goingDown) { dx = 0; dy = -TILE_SIZE; }
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (!goingLeft) { dx = TILE_SIZE; dy = 0; }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (!goingUp) { dx = 0; dy = TILE_SIZE; }
                    break;
                case ' ': // ç©ºç™½éµç”¨æ–¼æš«åœ
                    event.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
                    if (isGameOver) break;
                    isPaused ? startGame() : pauseGame();
                    break;
                case 'Enter':
                    if (isGameOver) {
                        startGame();
                    }
                    break;
            }

            // å¦‚æœéŠæˆ²å°šæœªé–‹å§‹ä¸”æ–¹å‘éµè¢«æŒ‰ä¸‹ï¼Œå‰‡é–‹å§‹éŠæˆ²
            if (isPaused && !isGameOver && (keyPressed.startsWith('Arrow') || ['w', 'a', 's', 'd'].includes(keyPressed.toLowerCase()))) {
                startGame();
            }
        });

        // è§¸æ§æ§åˆ¶é … (ä½¿ç”¨ä»£ç†äº‹ä»¶)
        document.getElementById('touchControls').addEventListener('click', (event) => {
            const button = event.target.closest('.touch-control');
            if (!button) return;

            const direction = button.getAttribute('data-direction');

            if (isPaused && !isGameOver) {
                startGame();
            }

            if (changingDirection) return;
            changingDirection = true;

            const goingUp = dy === -TILE_SIZE;
            const goingDown = dy === TILE_SIZE;
            const goingRight = dx === TILE_SIZE;
            const goingLeft = dx === -TILE_SIZE;

            switch (direction) {
                case 'UP':
                    if (!goingDown) { dx = 0; dy = -TILE_SIZE; }
                    break;
                case 'DOWN':
                    if (!goingUp) { dx = 0; dy = TILE_SIZE; }
                    break;
                case 'LEFT':
                    if (!goingRight) { dx = -TILE_SIZE; dy = 0; }
                    break;
                case 'RIGHT':
                    if (!goingLeft) { dx = TILE_SIZE; dy = 0; }
                    break;
            }
        });

        // æŒ‰éˆ•æ§åˆ¶é …
        startButton.addEventListener('click', startGame);
        pauseButton.addEventListener('click', pauseGame);

        // =================================================================
        // 5. Firebase / Firestore æœ€é«˜åˆ†æ•¸é‚è¼¯
        // =================================================================

        /**
         * å„²å­˜æœ€é«˜åˆ†æ•¸ã€‚
         * @param {number} newScore - ç©å®¶ç²å¾—çš„åˆ†æ•¸
         */
        async function saveHighScore(newScore) {
            // å¦‚æœ Firebase æœªæº–å‚™å¥½ï¼Œå‰‡è·³éå„²å­˜
            if (!window.isAuthReady || !window.db || !window.appId) return;

            // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦å€¼å¾—å„²å­˜
            const isWorthy = currentHighScores.length < MAX_HIGH_SCORES || newScore > currentHighScores[currentHighScores.length - 1].score;

            if (isWorthy) {
                const highScoresCollectionRef = window.firestore.collection(window.db, `artifacts/${window.appId}/public/data/snake_high_scores`);
               
                try {
                    // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç¶“æœ‰åˆ†æ•¸
                    const userQuery = window.firestore.query(highScoresCollectionRef, window.firestore.where('userId', '==', window.userId));
                    const userDocs = await window.firestore.getDocs(userQuery);
                   
                    if (userDocs.empty) {
                        // ä½¿ç”¨è€…æ²’æœ‰åˆ†æ•¸ï¼šæ–°å¢
                        await window.firestore.addDoc(highScoresCollectionRef, {
                            userId: window.userId,
                            score: newScore,
                            timestamp: Date.now()
                        });
                        console.log("æ–°å¢äº†æ–°çš„æœ€é«˜åˆ†æ•¸ã€‚");
                    } else {
                        // ä½¿ç”¨è€…å·²æœ‰åˆ†æ•¸ï¼šæ›´æ–°ï¼Œåƒ…ç•¶æ–°åˆ†æ•¸æ›´é«˜æ™‚
                        const userDoc = userDocs.docs[0];
                        if (newScore > userDoc.data().score) {
                            await window.firestore.updateDoc(userDoc.ref, {
                                score: newScore,
                                timestamp: Date.now()
                            });
                            console.log("æ›´æ–°äº†ç¾æœ‰çš„æœ€é«˜åˆ†æ•¸ã€‚");
                        }
                    }

                } catch (error) {
                    // ä½¿ç”¨æŒ‡æ•¸é€€é¿ç­–ç•¥é‡è©¦
                    let delay = 1000;
                    for (let i = 0; i < 3; i++) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        try {
                            // å†æ¬¡å˜—è©¦å„²å­˜é‚è¼¯ (ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡çœç•¥äº†å®Œæ•´çš„é‡è©¦é‚è¼¯)
                            console.log(`å„²å­˜æœ€é«˜åˆ†æ•¸å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦... å˜—è©¦ ${i + 1}`);
                            // é€™è£¡æ‡‰è©²é‡æ–°åŸ·è¡Œä¸Šé¢çš„ getDocs/addDoc/updateDoc é‚è¼¯
                            return; // å¦‚æœæˆåŠŸå‰‡é€€å‡º
                        } catch (e) {
                            // å¿½ç•¥é‡è©¦å¤±æ•—ï¼Œç¹¼çºŒä¸‹ä¸€æ¬¡å¾ªç’°
                        }
                    }
                    console.error("å„²å­˜æœ€é«˜åˆ†æ•¸å¤±æ•— (æ‰€æœ‰é‡è©¦çš†å¤±æ•—):", error);
                }
            }
        }


        /**
         * è¨­ç½® Firestore ç›£è½å™¨ä»¥å¯¦æ™‚æ›´æ–°æœ€é«˜åˆ†æ•¸æ¦œã€‚
         */
        function setupHighScoresListener() {
            if (!window.isAuthReady || !window.db || !window.appId) {
                console.warn("Firestore å°šæœªæº–å‚™å¥½ã€‚ç„¡æ³•ç›£è½æœ€é«˜åˆ†æ•¸ã€‚");
                return;
            }
           
            // æŸ¥è©¢ï¼šæŒ‰åˆ†æ•¸é™åºæ’åˆ—ï¼Œå–å‰ MAX_HIGH_SCORES ç­†
            const highScoresCollectionRef = window.firestore.collection(window.db, `artifacts/${window.appId}/public/data/snake_high_scores`);
            const q = window.firestore.query(
                highScoresCollectionRef,
                // æ³¨æ„: é€™è£¡ä½¿ç”¨ orderBy('score', 'desc') å¯èƒ½æœƒåœ¨æ²’æœ‰ç´¢å¼•æ™‚å°è‡´éŒ¯èª¤ï¼Œ
                // ä½†ç‚ºäº†å±•ç¤ºåŠŸèƒ½ï¼Œæš«æ™‚ä¿ç•™ã€‚å¦‚æœéƒ¨ç½²å¤±æ•—ï¼Œå»ºè­°åœ¨å‰ç«¯æ’åºã€‚
                window.firestore.orderBy('score', 'desc'),
                window.firestore.limit(MAX_HIGH_SCORES)
            );

            // è¨­ç½® onSnapshot å¯¦æ™‚ç›£è½å™¨
            window.firestore.onSnapshot(q, (snapshot) => {
                currentHighScores = [];
                snapshot.forEach((doc) => {
                    currentHighScores.push({ id: doc.id, ...doc.data() });
                });
               
                // æ¸²æŸ“åˆ†æ•¸åˆ—è¡¨
                renderHighScores();
            }, (error) => {
                console.error("å¾ Firestore ç²å–æœ€é«˜åˆ†æ•¸å¤±æ•—:", error);
                highScoresList.innerHTML = `<p class="text-center text-red-400">è¼‰å…¥æ•¸æ“šæµå¤±æ•—ï¼è«‹æª¢æŸ¥æ§åˆ¶å°ã€‚</p>`;
            });
        }

        /**
         * æ¸²æŸ“æœ€é«˜åˆ†æ•¸åˆ° HTML å…ƒç´ ä¸­ã€‚
         */
        function renderHighScores() {
            if (currentHighScores.length === 0) {
                highScoresList.innerHTML = `<p class="text-center text-gray-400">ç›®å‰é‚„æ²’æœ‰æ•¸æ“šåŒ…ï¼æˆç‚ºç¬¬ä¸€å€‹ä¸Šå‚³è€…å§ã€‚</p>`;
                return;
            }

            highScoresList.innerHTML = currentHighScores.map((item, index) => {
                // æˆªæ–· userId ä»¥ä¾¿é¡¯ç¤º
                const displayId = item.userId === window.userId ? 'æ‚¨ (å€‹äººç´€éŒ„)' : `${item.userId}`;
               
                return `
                    <div class="flex justify-between items-center p-3 rounded-lg ${index < 3 ? 'bg-fuchsia-800/50 border-2 border-fuchsia-400' : 'bg-gray-700'}">
                        <span class="text-lg font-bold w-8 text-center text-neon-cyan">${index + 1}.</span>
                        <!-- æ‡‰ç”¨é€£çµæ¨£å¼ -->
                        <span class="flex-1 font-mono text-sm break-all mr-2 user-id-link ${item.userId === window.userId ? 'text-neon-cyan' : 'text-gray-200'}">${displayId}</span>
                        <span class="text-xl font-extrabold text-neon-magenta">${item.score}</span>
                    </div>
                `;
            }).join('');
        }
       
        /**
         * åœ¨ Firebase èªè­‰å®Œæˆå¾Œï¼Œå•Ÿå‹•éŠæˆ²çš„å…¨éƒ¨é‚è¼¯ã€‚
         */
        window.initGameLogic = function() {
            // ç¢ºä¿åˆå§‹åŒ–é‚è¼¯åªé‹è¡Œä¸€æ¬¡
            if (window._gameInitialized) return;
            window._gameInitialized = true;
           
            // åˆå§‹è¨­ç½®
            initializeGame();
           
            // è¨­ç½®æœ€é«˜åˆ†æ•¸ç›£è½å™¨
            setupHighScoresListener();

            // è™•ç†åˆæ¬¡èª¿æ•´å¤§å°
            resizeCanvas();
        };

        // å¦‚æœ Firebase è…³æœ¬æœªèƒ½åˆå§‹åŒ– window.isAuthReady (ä¾‹å¦‚æ²’æœ‰é…ç½®)ï¼Œå‰‡å¼·åˆ¶åŸ·è¡Œåˆå§‹åŒ–
        // å¦å‰‡ï¼Œå®ƒå°‡ç”± onAuthStateChanged è§¸ç™¼
        if (typeof window.isAuthReady === 'undefined') {
            window.initGameLogic();
        }
    </script>
</body>
</html>

